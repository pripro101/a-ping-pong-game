<!-- [Previous HTML remains the same until the script section] -->

<script>
  // Initialize Supabase properly
  const supabaseUrl = 'https://xvdeijzqjumkvchxabwc.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2ZGVpanpxanVta3ZjaHhhYndjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwODMwMzEsImV4cCI6MjA2ODY1OTAzMX0.kf6fCNd4n2sVcb06qyHo9zJ_7lRxMUZgryaGbp2mDJ8';
  const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

  // DOM elements
  const leaderboardList = document.getElementById('leaderboardList');
  const searchInput = document.getElementById('searchInput');
  const searchBtn = document.getElementById('searchBtn');
  const loadingElement = document.getElementById('loading');
  const lastUpdated = document.getElementById('lastUpdated');

  // Current user from URL
  const urlParams = new URLSearchParams(window.location.search);
  const currentUser = urlParams.get('user');

  // Fetch leaderboard data with error handling
  async function fetchLeaderboard(searchTerm = '') {
    try {
      loadingElement.style.display = 'block';
      leaderboardList.innerHTML = '';
      
      // First verify connection
      const { data: testData, error: testError } = await supabase
        .from('Leaderboard')
        .select('*')
        .limit(1);
      
      if (testError) throw testError;

      // Main query
      let query = supabase
        .from('Leaderboard')
        .select('id, username, score, level, created_at')
        .order('score', { ascending: false })
        .limit(100);

      if (searchTerm.trim()) {
        query = query.ilike('username', `%${searchTerm.trim()}%`);
      }

      const { data, error } = await query;

      if (error) throw error;

      loadingElement.style.display = 'none';
      
      if (!data || data.length === 0) {
        leaderboardList.innerHTML = '<li class="leaderboard-item">No scores yet. Be the first!</li>';
        return;
      }

      // Render leaderboard items
      data.forEach((entry, index) => {
        const li = document.createElement('li');
        li.className = 'leaderboard-item';
        
        // Highlight current user
        if (currentUser && entry.username === currentUser) {
          li.classList.add('current-user');
        }

        // Top 3 styling
        let rankClass = '';
        let medalIcon = '';
        if (index === 0) {
          rankClass = 'rank-1';
          medalIcon = '<i class="fas fa-crown"></i>';
        } else if (index === 1) {
          rankClass = 'rank-2';
          medalIcon = '<i class="fas fa-medal"></i>';
        } else if (index === 2) {
          rankClass = 'rank-3';
          medalIcon = '<i class="fas fa-medal"></i>';
        }

        li.innerHTML = `
          <div class="rank ${rankClass}">${medalIcon}${index + 1}</div>
          <div class="user-info">
            <span class="username">${entry.username}</span>
          </div>
          <div>
            <span class="score">${entry.score} pts</span>
            <span class="level">(Level ${entry.level})</span>
          </div>
        `;
        leaderboardList.appendChild(li);
      });

      lastUpdated.textContent = `Last updated: ${new Date().toLocaleString()}`;

    } catch (error) {
      console.error('Leaderboard error:', error);
      loadingElement.style.display = 'none';
      leaderboardList.innerHTML = `
        <li class="leaderboard-item error">
          <i class="fas fa-exclamation-triangle"></i>
          ${error.message || 'Failed to load leaderboard'}
        </li>
      `;
    }
  }

  // [Rest of the event listeners remain the same...]
</script>